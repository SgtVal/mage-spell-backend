// Helper to get userId from URL ?userId=12345
function getUserId() {
  const params = new URLSearchParams(window.location.search);
  return params.get('userId') || null;
}

const playerId = getUserId();
const backendURL = "https://mage-spell-api.onrender.com";

let recognitionActive = false;

const recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition.lang = 'en-US';
recognition.interimResults = false;

recognition.onresult = (event) => {
  const transcript = event.results[0][0].transcript.toLowerCase();
  status.innerText = "üó£Ô∏è Heard: " + transcript;

  fetch(backendURL + "/cast", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ userId: playerId, spell: transcript })
  }).then(() => {
    status.innerText = "‚úÖ Spell Sent: " + transcript;
  }).catch(() => {
    status.innerText = "‚ùå Error sending spell";
  });
};

recognition.onerror = (event) => {
  status.innerText = "‚ö†Ô∏è Error: " + event.error;
};

function startRecognition() {
  if (!recognitionActive) {
    recognition.start();
    recognitionActive = true;
    status.innerText = "üéß Listening...";
  }
}

function stopRecognition() {
  if (recognitionActive) {
    recognition.stop();
    recognitionActive = false;
    status.innerText = "‚è≥ Processing...";
  }
}

// Poll Roblox backend every 2 seconds to check if it wants to listen
setInterval(() => {
  if (!playerId) {
    status.innerText = "‚ùå No userId in URL";
    return;
  }
  fetch(`${backendURL}/listening/${playerId}`)
    .then(res => res.json())
    .then(data => {
      if (data.active && !recognitionActive) {
        startRecognition();
      } else if (!data.active && recognitionActive) {
        stopRecognition();
      }
    })
    .catch(() => {
      status.innerText = "‚ö†Ô∏è Network error";
    });
}, 2000);
